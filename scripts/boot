#!/opt/Xilinx/Vivado/2017.3/bin/xsdb
set img "/home/igalanommatis/work/zdma/image"

#puts stderr "INFO: Compiling Device-Tree..."
#exec -ignorestderr dtc -I dts -O dtb $img/dts/system-top.dts -o $img/devicetree.dtb

puts stderr "INFO: Resetting all ARM targets..."
connect -url 127.0.0.1:3121
set items [split [targets] \n]
foreach line $items {
	set index [ scan $line %d]
	if {[string match "*ARM*" $line] == 1} {
		target $index
		rst
	}
}
after 500

puts stderr "INFO: Configuring the FPGA..."
puts stderr "INFO: Downloading bitstream to the target."
fpga "$img/download.bit"
after 1000
targets -set -nocase -filter {name =~ "arm*#0"}
dow -data "$img/u-boot-spl.bin" 0x0
rwr pc 0x0
con
after 1000
stop

dow "$img/u-boot.elf"
con
after 1000
stop

dow -data "$img/uImage" 0x2000000
after 1000
dow -data "$img/core-image-minimal-zedboard-zynq7.cpio.gz.u-boot" 0x3000000
after 1000
dow -data "$img/zynq-zed.dtb" 0x2A00000
after 1000
con


